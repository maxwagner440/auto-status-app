@if (job(); as j) {
  <div class="job-detail-container">
    <!-- Job Info Card -->
    <div class="card job-info-card">
      <h2>Job Details</h2>
      <div class="job-info-grid">
        <div class="job-info-item">
          <div class="text-xs mb-sm">Vehicle</div>
          <div class="strong">{{ j.vehicleLabel }}</div>
        </div>
        <div class="job-info-item">
          <div class="text-xs mb-sm">Customer contact</div>
          <div>{{ j.customerContact }}</div>
        </div>
        <div class="job-info-item">
          <div class="text-xs mb-sm">Last updated</div>
          <div>{{ formatDate(j.updatedAt) }}</div>
        </div>
        @if (!j.active) {
          <div class="job-info-item">
            <div class="text-xs mb-sm">Status</div>
            <div class="text-xs text-muted">Inactive</div>
          </div>
        }
      </div>
    </div>

    <!-- Status Update Card -->
    <div class="card status-update-card" [class.closed-job]="isClosed()">
      @if (isClosed()) {
        <div class="closed-banner">
          <strong>This job is closed and read-only.</strong> Reactivate it to make changes.
        </div>
      }
      <h3>Update Status</h3>
      
      <div class="status-form">
        <div class="status-field">
          <label for="state-select">State</label>
          <select 
            id="state-select" 
            [ngModel]="stateKey()" 
            (ngModelChange)="stateKey.set($event)"
            aria-label="Select job state"
            [disabled]="isClosed()"
            [attr.aria-disabled]="isClosed()"
          >
            @for (s of states(); track s.key) {
              <option [value]="s.key">{{ s.label }}</option>
            }
          </select>
          @if (stateKey() && selectedStateBlurb()) {
            <div class="blurb-preview">
              <div class="text-xs mb-xs">What customer sees:</div>
              <div class="text-sm">{{ selectedStateBlurb() }}</div>
            </div>
          }
        </div>

        <div class="status-field">
          <label for="flag-select">Flag</label>
          <select 
            id="flag-select" 
            [ngModel]="flagKey()" 
            (ngModelChange)="flagKey.set($event)"
            aria-label="Select job flag"
            [disabled]="isClosed()"
            [attr.aria-disabled]="isClosed()"
          >
            @for (f of flags(); track f.key) {
              <option [value]="f.key">{{ f.label }}</option>
            }
          </select>
          @if (selectedFlagBlurb() && flagKey() !== 'NONE') {
            <div class="blurb-preview">
              <div class="text-xs mb-xs">What customer sees:</div>
              <div class="text-sm">{{ selectedFlagBlurb() }}</div>
            </div>
          }
        </div>
      </div>

      <div class="status-actions">
        <button 
          class="btn btn-primary" 
          (click)="save()"
          [disabled]="!hasChanges() || isClosed()"
          [attr.aria-label]="isClosed() ? 'Save disabled - job is closed' : (hasChanges() ? 'Save status changes' : 'Save button disabled - no changes made')"
        >
          Save
        </button>
      </div>

      @if (message()) {
        <div class="message" [class.success]="message().includes('Saved') || message().includes('copied') || message().includes('reactivated')">
          {{ message() }}
        </div>
      }
    </div>

    <!-- Actions Card -->
    <div class="card actions-card">
      <h3>Actions</h3>
      <div class="actions-grid">
        <div class="action-item">
          <div class="text-xs mb-sm">Customer Link</div>
          <div class="link-container">
            <code class="customer-url">{{ customerHref() }}</code>
            <button class="btn btn-secondary btn-sm" (click)="copyCustomerLink()" aria-label="Copy customer link to clipboard">
              Copy link
            </button>
          </div>
        </div>
        @if (j.active) {
          <div class="action-item">
            <button class="btn btn-secondary" (click)="confirmCloseJob()" aria-label="Close this job">
              Close job
            </button>
          </div>
        } @else {
          <div class="action-item">
            <button class="btn btn-primary" (click)="confirmReactivateJob()" aria-label="Reactivate this job">
              Reactivate job
            </button>
          </div>
        }
      </div>
    </div>

    <!-- Close Job Confirmation Dialog -->
    @if (showCloseConfirm()) {
      <div class="confirm-dialog-overlay" (click)="cancelCloseJob()">
        <div class="confirm-dialog" (click)="$event.stopPropagation()">
          <h3>Close Job</h3>
          <p class="text-sm">Are you sure you want to close this job? The job will become read-only and cannot be modified until reactivated.</p>
          <div class="dialog-actions">
            <button class="btn btn-secondary" (click)="cancelCloseJob()" aria-label="Cancel closing job">Cancel</button>
            <button class="btn btn-primary" (click)="closeJob()" aria-label="Confirm close job">Close Job</button>
          </div>
        </div>
      </div>
    }

    <!-- Reactivate Job Confirmation Dialog -->
    @if (showReactivateConfirm()) {
      <div class="confirm-dialog-overlay" (click)="cancelReactivateJob()">
        <div class="confirm-dialog" (click)="$event.stopPropagation()">
          <h3>Reactivate Job</h3>
          <p class="text-sm">Are you sure you want to reactivate this job? You will be able to modify its status and flags again.</p>
          <div class="dialog-actions">
            <button class="btn btn-secondary" (click)="cancelReactivateJob()" aria-label="Cancel reactivating job">Cancel</button>
            <button class="btn btn-primary" (click)="reactivateJob()" aria-label="Confirm reactivate job">Reactivate Job</button>
          </div>
        </div>
      </div>
    }
  </div>
} @else {
  <div class="card">
    <div class="text-sm">Loading...</div>
  </div>
}

